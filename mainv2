local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager") -- WICHTIG für echte Klicks

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- === EINSTELLUNGEN ===
local LOCK_KEY = Enum.UserInputType.MouseButton2 -- Aimlock Taste
local AIM_PART = "Head" 
local FOV_LIMIT = 400 
local FIRE_RATE = 0.1 -- Wie schnell geklickt wird (nicht zu schnell, sonst verschluckt sich die Waffe)
local USE_TEAM_CHECK = false 
local TRIGGER_ENABLED = true 

-- Variablen
local isLocked = false
local currentTarget = nil
local lastShotTime = 0

-----------------------------------------------------------------------
-- TEIL 1: HIGHLIGHTS & NAMETAGS (Blau)
-----------------------------------------------------------------------
local function createVisuals(targetChar, playerObj)
	if targetChar == player.Character then return end
	
	-- 1. Highlight
	if not targetChar:FindFirstChild("GlowEffect") then
		local highlight = Instance.new("Highlight")
		highlight.Name = "GlowEffect"
		highlight.Adornee = targetChar
		highlight.FillColor = Color3.fromRGB(0, 85, 255) -- Blau
		highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
		highlight.FillTransparency = 0.5
		highlight.Parent = targetChar
	end

	-- 2. Nametag
	local head = targetChar:FindFirstChild("Head")
	if head and not targetChar:FindFirstChild("ESP_Nametag") then
		local bb = Instance.new("BillboardGui")
		bb.Name = "ESP_Nametag"
		bb.Adornee = head
		bb.Size = UDim2.new(0, 200, 0, 50)
		bb.StudsOffset = Vector3.new(0, 3, 0)
		bb.AlwaysOnTop = true 

		local txt = Instance.new("TextLabel")
		txt.Parent = bb
		txt.BackgroundTransparency = 1
		txt.Size = UDim2.new(1, 0, 1, 0)
		txt.TextStrokeTransparency = 0 
		txt.TextColor3 = Color3.fromRGB(0, 170, 255) -- Hellblau
		txt.TextSize = 14
		txt.Font = Enum.Font.SourceSansBold
		
		local humanoid = targetChar:FindFirstChild("Humanoid")
		local function updateText()
			if humanoid then
				local hp = math.floor(humanoid.Health)
				txt.Text = playerObj.Name .. " [" .. hp .. "%]"
			end
		end
		
		updateText()
		if humanoid then humanoid.HealthChanged:Connect(updateText) end
		bb.Parent = targetChar
	end
end

local function setupPlayer(otherPlayer)
	if otherPlayer == player then return end
	otherPlayer.CharacterAdded:Connect(function(char)
		task.wait(0.5)
		createVisuals(char, otherPlayer)
	end)
	if otherPlayer.Character then createVisuals(otherPlayer.Character, otherPlayer) end
end

for _, p in ipairs(Players:GetPlayers()) do setupPlayer(p) end
Players.PlayerAdded:Connect(setupPlayer)

-----------------------------------------------------------------------
-- TEIL 2: ECHTER MAUSKLICK (VirtualInputManager)
-----------------------------------------------------------------------
local function performClick()
	if tick() - lastShotTime < FIRE_RATE then return end
	lastShotTime = tick()
	
	-- Prüfen ob Tool ausgerüstet ist
	local char = player.Character
	if char and char:FindFirstChildWhichIsA("Tool") then
		
		local x, y = 0, 0 -- Koordinaten sind egal bei Button1
		
		-- 1. Maustaste DRÜCKEN
		VirtualInputManager:SendMouseButtonEvent(x, y, 0, true, game, 1)
		
		-- 2. Ganz kurz warten (Wichtig für manche Waffen)
		task.wait(0.05)
		
		-- 3. Maustaste LOSLASSEN
		VirtualInputManager:SendMouseButtonEvent(x, y, 0, false, game, 1)
		
		-- Das sorgt dafür, dass die Waffe im Spiel wirklich feuert
	end
end

-----------------------------------------------------------------------
-- TEIL 3: TRIGGERBOT LOGIK
-----------------------------------------------------------------------
local function checkTriggerBot()
	if not TRIGGER_ENABLED then return end
	
	local mouseLocation = UserInputService:GetMouseLocation()
	local ray = camera:ViewportPointToRay(mouseLocation.X, mouseLocation.Y)
	
	local params = RaycastParams.new()
	params.FilterDescendantsInstances = {player.Character}
	params.FilterType = Enum.RaycastFilterType.Exclude
	
	local result = workspace:Raycast(ray.Origin, ray.Direction * 1000, params)
	
	if result and result.Instance then
		local hitPart = result.Instance
		
		-- Teil gehört zu einem Charakter?
		local character = hitPart.Parent
		if character:IsA("Accessory") then character = character.Parent end 
		
		local humanoid = character:FindFirstChild("Humanoid")
		
		if humanoid and humanoid.Health > 0 then
			local enemyPlayer = Players:GetPlayerFromCharacter(character)
			
			if USE_TEAM_CHECK and enemyPlayer and enemyPlayer.Team == player.Team then return end
			
			-- Echter Klick ausführen
			performClick()
		end
	end
end

-----------------------------------------------------------------------
-- TEIL 4: AIM LOCK (Mouse Closest)
-----------------------------------------------------------------------
local function getTargetUnderMouse()
	local closestTarget = nil
	local shortestDistance = FOV_LIMIT
	local mousePos = UserInputService:GetMouseLocation()

	for _, otherPlayer in ipairs(Players:GetPlayers()) do
		if otherPlayer ~= player and otherPlayer.Character then
			local char = otherPlayer.Character
			local humanoid = char:FindFirstChild("Humanoid")
			local targetPartObj = char:FindFirstChild(AIM_PART)

			if humanoid and humanoid.Health > 0 and targetPartObj then
				if USE_TEAM_CHECK and otherPlayer.Team == player.Team then continue end

				local screenPos, onScreen = camera:WorldToViewportPoint(targetPartObj.Position)

				if onScreen then
					local distToMouse = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
					if distToMouse < shortestDistance then
						closestTarget = targetPartObj
						shortestDistance = distToMouse
					end
				end
			end
		end
	end
	return closestTarget
end

UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.UserInputType == LOCK_KEY then
		local found = getTargetUnderMouse()
		if found then
			currentTarget = found
			isLocked = true
		end
	end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == LOCK_KEY then
		isLocked = false
		currentTarget = nil
	end
end)

-----------------------------------------------------------------------
-- TEIL 5: INFINITE JUMP
-----------------------------------------------------------------------
UserInputService.JumpRequest:Connect(function()
	if player.Character and player.Character:FindFirstChild("Humanoid") then
		player.Character.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
	end
end)

-----------------------------------------------------------------------
-- MAIN LOOP
-----------------------------------------------------------------------
RunService.RenderStepped:Connect(function()
	-- 1. Aimlock
	if isLocked and currentTarget and currentTarget.Parent then
		local humanoid = currentTarget.Parent:FindFirstChild("Humanoid")
		if humanoid and humanoid.Health > 0 then
			camera.CFrame = CFrame.new(camera.CFrame.Position, currentTarget.Position)
		else
			isLocked = false
			currentTarget = nil
		end
	end
	
	-- 2. Triggerbot
	checkTriggerBot()
end)
