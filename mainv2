local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- === EINSTELLUNGEN ===
local LOCK_KEY = Enum.UserInputType.MouseButton2 -- Taste für Aimlock (Rechtsklick)
local AIM_PART = "Head" -- Worauf gezielt wird
local FOV_LIMIT = 400 -- Radius um die Maus (in Pixeln)
local USE_TEAM_CHECK = false -- True = Teammitglieder ignorieren

-- Variablen
local isLocked = false
local currentTarget = nil

-----------------------------------------------------------------------
-- TEIL 1: HIGHLIGHTS & NAMETAGS (Visuals)
-----------------------------------------------------------------------
local function createVisuals(targetChar, playerObj)
	if targetChar == player.Character then return end
	
	-- 1. Highlight (Blaues Leuchten)
	if not targetChar:FindFirstChild("GlowEffect") then
		local highlight = Instance.new("Highlight")
		highlight.Name = "GlowEffect"
		highlight.Adornee = targetChar
		
		highlight.FillColor = Color3.fromRGB(0, 85, 255) -- Kräftiges Blau
		highlight.OutlineColor = Color3.fromRGB(255, 255, 255) -- Weißer Rand
		
		highlight.FillTransparency = 0.5
		highlight.OutlineTransparency = 0
		highlight.Parent = targetChar
	end

	-- 2. Nametag (Blauer Text über dem Kopf)
	local head = targetChar:FindFirstChild("Head")
	if head and not targetChar:FindFirstChild("ESP_Nametag") then
		local bb = Instance.new("BillboardGui")
		bb.Name = "ESP_Nametag"
		bb.Adornee = head
		bb.Size = UDim2.new(0, 200, 0, 50)
		bb.StudsOffset = Vector3.new(0, 3, 0)
		bb.AlwaysOnTop = true 

		local txt = Instance.new("TextLabel")
		txt.Parent = bb
		txt.BackgroundTransparency = 1
		txt.Size = UDim2.new(1, 0, 1, 0)
		txt.TextStrokeTransparency = 0 
		
		txt.TextColor3 = Color3.fromRGB(0, 170, 255) -- Hellblau
		txt.TextSize = 14
		txt.Font = Enum.Font.SourceSansBold
		
		local humanoid = targetChar:FindFirstChild("Humanoid")
		local function updateText()
			if humanoid then
				local hp = math.floor(humanoid.Health)
				txt.Text = playerObj.Name .. " [" .. hp .. "%]"
			end
		end
		
		updateText()
		if humanoid then humanoid.HealthChanged:Connect(updateText) end
		bb.Parent = targetChar
	end
end

local function setupPlayer(otherPlayer)
	if otherPlayer == player then return end
	
	otherPlayer.CharacterAdded:Connect(function(char)
		task.wait(0.5)
		createVisuals(char, otherPlayer)
	end)
	
	if otherPlayer.Character then 
		createVisuals(otherPlayer.Character, otherPlayer) 
	end
end

for _, p in ipairs(Players:GetPlayers()) do setupPlayer(p) end
Players.PlayerAdded:Connect(setupPlayer)

-----------------------------------------------------------------------
-- TEIL 2: AIM LOCK LOGIK (Mouse Closest)
-----------------------------------------------------------------------
local function getTargetUnderMouse()
	local closestTarget = nil
	local shortestDistance = FOV_LIMIT -- Nur Ziele innerhalb dieses Radius
	local mousePos = UserInputService:GetMouseLocation()

	for _, otherPlayer in ipairs(Players:GetPlayers()) do
		if otherPlayer ~= player and otherPlayer.Character then
			local char = otherPlayer.Character
			local humanoid = char:FindFirstChild("Humanoid")
			local targetPartObj = char:FindFirstChild(AIM_PART)

			if humanoid and humanoid.Health > 0 and targetPartObj then
				if USE_TEAM_CHECK and otherPlayer.Team == player.Team then continue end

				-- 1. Ist der Spieler auf dem Bildschirm sichtbar?
				local screenPos, onScreen = camera:WorldToViewportPoint(targetPartObj.Position)

				if onScreen then
					-- 2. Abstand von der Maus zum Kopf berechnen (2D)
					local distToMouse = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude

					-- 3. Den wählen, der am nächsten an der Maus ist
					if distToMouse < shortestDistance then
						closestTarget = targetPartObj
						shortestDistance = distToMouse
					end
				end
			end
		end
	end
	return closestTarget
end

-- Aimlock Inputs
UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.UserInputType == LOCK_KEY then
		local found = getTargetUnderMouse()
		if found then
			currentTarget = found
			isLocked = true
		end
	end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == LOCK_KEY then
		isLocked = false
		currentTarget = nil
	end
end)

-----------------------------------------------------------------------
-- TEIL 3: INFINITE JUMP (Unendlich Springen)
-----------------------------------------------------------------------
UserInputService.JumpRequest:Connect(function()
	-- Wenn der Spieler springen will (Leertaste), erzwingen wir den Sprung
	-- auch wenn er in der Luft ist.
	if player.Character and player.Character:FindFirstChild("Humanoid") then
		player.Character.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
	end
end)

-----------------------------------------------------------------------
-- MAIN LOOP
-----------------------------------------------------------------------
RunService.RenderStepped:Connect(function()
	-- Bewegt die Kamera auf das Ziel
	if isLocked and currentTarget and currentTarget.Parent then
		local humanoid = currentTarget.Parent:FindFirstChild("Humanoid")
		if humanoid and humanoid.Health > 0 then
			camera.CFrame = CFrame.new(camera.CFrame.Position, currentTarget.Position)
		else
			isLocked = false
			currentTarget = nil
		end
	end
end)
