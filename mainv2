local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- === EINSTELLUNGEN ===
local LOCK_KEY = Enum.UserInputType.MouseButton2 -- Taste f체r Aimlock
local AIM_PART = "Head" 
local FOV_LIMIT = 400 -- Wie weit darf der Gegner vom Mauszeiger weg sein, um gelockt zu werden? (Pixel)
local USE_TEAM_CHECK = false
local FIRE_RATE = 0.1
local TRIGGER_ENABLED = true 

-- Variablen
local isLocked = false
local currentTarget = nil
local lastShotTime = 0

-----------------------------------------------------------------------
-- TEIL 1: HIGHLIGHTS & NAMETAGS (Visuals)
-----------------------------------------------------------------------
local function createVisuals(targetChar, playerObj)
	if targetChar == player.Character then return end
	
	-- 1. Highlight
	if not targetChar:FindFirstChild("GlowEffect") then
		local highlight = Instance.new("Highlight")
		highlight.Name = "GlowEffect"
		highlight.Adornee = targetChar
		highlight.FillColor = Color3.fromRGB(255, 0, 0)
		highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
		highlight.FillTransparency = 0.6
		highlight.OutlineTransparency = 0.1
		highlight.Parent = targetChar
	end

	-- 2. Nametag
	local head = targetChar:FindFirstChild("Head")
	if head and not targetChar:FindFirstChild("ESP_Nametag") then
		local bb = Instance.new("BillboardGui")
		bb.Name = "ESP_Nametag"
		bb.Adornee = head
		bb.Size = UDim2.new(0, 200, 0, 50)
		bb.StudsOffset = Vector3.new(0, 3, 0)
		bb.AlwaysOnTop = true

		local txt = Instance.new("TextLabel")
		txt.Parent = bb
		txt.BackgroundTransparency = 1
		txt.Size = UDim2.new(1, 0, 1, 0)
		txt.TextStrokeTransparency = 0
		txt.TextColor3 = Color3.fromRGB(255, 255, 255)
		txt.TextSize = 14
		txt.Font = Enum.Font.SourceSansBold
		
		local humanoid = targetChar:FindFirstChild("Humanoid")
		local function updateText()
			if humanoid then
				local hp = math.floor(humanoid.Health)
				txt.Text = playerObj.Name .. " [" .. hp .. "%]"
				if hp > 50 then
					txt.TextColor3 = Color3.fromRGB(0, 255, 0)
				else
					txt.TextColor3 = Color3.fromRGB(255, 0, 0)
				end
			end
		end
		
		updateText()
		if humanoid then humanoid.HealthChanged:Connect(updateText) end
		bb.Parent = targetChar
	end
end

local function setupPlayer(otherPlayer)
	if otherPlayer == player then return end
	otherPlayer.CharacterAdded:Connect(function(char)
		task.wait(0.5)
		createVisuals(char, otherPlayer)
	end)
	if otherPlayer.Character then createVisuals(otherPlayer.Character, otherPlayer) end
end

for _, p in ipairs(Players:GetPlayers()) do setupPlayer(p) end
Players.PlayerAdded:Connect(setupPlayer)

-----------------------------------------------------------------------
-- TEIL 2: WAFFEN LOGIK
-----------------------------------------------------------------------
local function fireWeapon(targetPos)
	if tick() - lastShotTime < FIRE_RATE then return end
	lastShotTime = tick()
	
	local char = player.Character
	local tool = char and char:FindFirstChildWhichIsA("Tool")
	
	if tool then
		local origin = (tool:FindFirstChild("Handle") and tool.Handle.Position) or char.Head.Position
		
		local beam = Instance.new("Part")
		beam.Anchored = true
		beam.CanCollide = false
		beam.Material = Enum.Material.Neon
		beam.Color = Color3.fromRGB(255, 255, 0)
		beam.Size = Vector3.new(0.1, 0.1, (targetPos - origin).Magnitude)
		beam.CFrame = CFrame.lookAt(origin, targetPos) * CFrame.new(0, 0, -beam.Size.Z/2)
		beam.Parent = workspace
		game:GetService("Debris"):AddItem(beam, 0.05)
		
		-- print("TRIGGERBOT: Treffer!")
		-- tool.RemoteEvent:FireServer(targetPos)
	end
end

-----------------------------------------------------------------------
-- TEIL 3: TRIGGERBOT LOGIK
-----------------------------------------------------------------------
local function checkTriggerBot()
	if not TRIGGER_ENABLED then return end
	
	local mouseLocation = UserInputService:GetMouseLocation()
	local ray = camera:ViewportPointToRay(mouseLocation.X, mouseLocation.Y)
	
	local params = RaycastParams.new()
	params.FilterDescendantsInstances = {player.Character}
	params.FilterType = Enum.RaycastFilterType.Exclude
	
	local result = workspace:Raycast(ray.Origin, ray.Direction * 1000, params)
	
	if result and result.Instance then
		local hitPart = result.Instance
		if hitPart.Parent:FindFirstChild("Humanoid") then
			local enemyPlayer = Players:GetPlayerFromCharacter(hitPart.Parent)
			local hum = hitPart.Parent.Humanoid
			
			if hum.Health > 0 then
				if USE_TEAM_CHECK and enemyPlayer and enemyPlayer.Team == player.Team then return end
				fireWeapon(result.Position)
			end
		end
	end
end

-----------------------------------------------------------------------
-- TEIL 4: AIM LOCK LOGIK (MOUSE CLOSEST)
-----------------------------------------------------------------------
local function getTargetUnderMouse()
	local closestTarget = nil
	local shortestDistance = FOV_LIMIT -- Nur Ziele innerhalb dieses Radius
	local mousePos = UserInputService:GetMouseLocation()

	for _, otherPlayer in ipairs(Players:GetPlayers()) do
		if otherPlayer ~= player and otherPlayer.Character then
			local char = otherPlayer.Character
			local humanoid = char:FindFirstChild("Humanoid")
			local targetPartObj = char:FindFirstChild(AIM_PART)

			if humanoid and humanoid.Health > 0 and targetPartObj then
				if USE_TEAM_CHECK and otherPlayer.Team == player.Team then continue end

				-- 1. Pr체fen: Ist der Spieler 체berhaupt auf dem Bildschirm?
				local screenPos, onScreen = camera:WorldToViewportPoint(targetPartObj.Position)

				if onScreen then
					-- 2. Distanz vom Mauszeiger zum Kopf berechnen (in 2D Pixeln)
					local distToMouse = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude

					-- 3. Wenn dieser Spieler n채her an der Maus ist als der vorherige -> Neuer Favorit
					if distToMouse < shortestDistance then
						closestTarget = targetPartObj
						shortestDistance = distToMouse
					end
				end
			end
		end
	end
	return closestTarget
end

UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.UserInputType == LOCK_KEY then
		-- Hier rufen wir jetzt die neue Funktion auf
		local found = getTargetUnderMouse()
		if found then
			currentTarget = found
			isLocked = true
		end
	end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == LOCK_KEY then
		isLocked = false
		currentTarget = nil
	end
end)

-----------------------------------------------------------------------
-- MAIN LOOP
-----------------------------------------------------------------------
RunService.RenderStepped:Connect(function()
	-- 1. Aimlock
	if isLocked and currentTarget and currentTarget.Parent then
		local humanoid = currentTarget.Parent:FindFirstChild("Humanoid")
		if humanoid and humanoid.Health > 0 then
			camera.CFrame = CFrame.new(camera.CFrame.Position, currentTarget.Position)
		else
			isLocked = false
			currentTarget = nil
		end
	end
	
	-- 2. Triggerbot
	checkTriggerBot()
end)
